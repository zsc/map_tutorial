# 第 12 章：多尺度地图发布——从全球到底层室内

## 1. 开篇：构建“全息”地球

在前述章节中，我们像收集拼图一样准备了各种素材：天地图提供了全球底图，吉林一号提供了城市级高清影像，DEM 赋予了地表起伏，街景记录了立面信息，而 BIM 则描绘了建筑内部的微观世界。

本章的任务是**系统集成（System Integration）**。我们要构建一个能够承载这所有数据的“容器”。这不仅仅是将图层叠加，而是一场关于**空间索引、渲染调度和用户体验**的复杂编排。

我们的目标是实现一个**无级缩放（Seamless Zooming）**的地图应用：用户可以从数万公里的高空俯瞰地球，平滑地推近到某座城市查看正射影像，接着降落到街道查看全景，最终透墙壁进入室内查看房间布局。这构成了 GIS 领域终极的“全空间”表达。

---

## 2. 核心架构：多尺度数据金字塔 (LOD)

要在一个浏览器窗口中流畅展示 TB 级的数据，核心原则只有一个：**按需加载（Load on Demand）**。我们将这一策略称为细节层次（LOD, Level of Detail）。

我们可以将地图的视口缩放（Zoom Level）映射为四个主要的数据治理层级：

### 2.1 L0：全球概览层 (Macro Scale)
- **视口范围**：Zoom 0 - 9（大洲到省/州级）
- **核心数据**：
  - **影像**：全球 15米/30米 低分镶嵌影像（如 Landsat, Sentinel-2 缩略图, Blue Marble）。
  - **矢量**：国界、省界、主要路网骨架。
  - **地形**：全球 90米/30米 DEM（SRTM/ASTER），用于在地球边缘渲染大气层效果和宏观地形起伏。
- **渲染策略**：
  - **性能优先**。严禁加载高分切片。
  - 使用预渲染的栅格瓦片（XYZ / WMTS），前端仅负责“贴图。

### 2.2 L1：城市与地形层 (Meso Scale)
- **视口范围**：Zoom 10 - 15（城市到街区级）
- **核心数据**：
  - **影像**：**吉林一号**、Google Earth 等亚米级（0.5m - 0.75m）高分正射影像。
  - **矢量**：详细路网、水系、绿地、POI（兴趣点）图标。
  - **3D**：地形网格（Terrain Mesh）细化，城市建筑白模（Extruded Polygons）开始出现。
- **渲染策略**：
  - **视锥体剔除（Frustum Culling）**：只加载屏幕可视范围内的瓦片。
  - 影像与地形需严格对齐，避免“纹理拉伸”。

### 2.3 L2：街景与精细模型层 (Micro Scale)
- **视口范围**：Zoom 16 - 19（街道到单体建筑级）
- **核心数据**：
  - **倾斜摄影**：OSGB 转 3D Tiles，展示建筑立面和屋顶细节。
  - **街景**：车载/背包采集的 360° 全景照片序列。
  - **交通设施**：车道线、红绿灯、路灯等高精地图要素。
- **渲染策略**：
  - **流式传输**：3D Tiles 技术HLOD）登场，根据相机距离动态加载几何精度。
  - 街景数据通常以“气泡（Bubble）”或“蓝色路网覆盖”形式存在，点击后切换视图模式。

### 2.4 L3：室内与构件层 (Nano Scale)
- **视口范围**：Zoom 20+（进入建筑内部）
- **核心数据**：
  - **BIM/CAD 转换数据**：楼板、墙体、门窗、室内家具、暖通管道。
  - **室内拓扑**：用于导航的路网节点（Node-Edge）。
- **渲染策略**：
  - **剖切（Clipping）**：必须隐藏屋顶和外墙，或使用“楼层过滤器”仅渲染特定 Z 轴高度的数据。
  - 坐标系通常需从地理坐标转换为局部工程坐标以便于交互。

---

## 3. 关键技术栈：数据标准与协议

要将上述四层数据“粘”在一起，需要标准化的数据协议。

### 3.1 影像与地形的“瓦片化”
任何栅格数据（卫星图、DEM）都必须切片。

- **影像瓦片标准**：`XYZ` 或 `WMTS`。
  - 目录结构通常为 `/z/x/y.png`
  - 这里的 $x, y$ 是基于 Web Mercator 网格的索引。
- **地形瓦片标准**：
  - **Quantized Mesh (Cesium)**：最主流的 3D 地形格式，支持地形本身的 TIN（不规则三角网）层级结构。
  - **Heightmap (Mapbox)**：将高程值编码为 RGB 颜色的图片，前端解码生成高度。

### 3.2 三维模型的“流式传输”
BIM 和倾斜摄影数据量巨大，无法一次性下载。

- **3D Tiles (OGC 标准)**：
  - 专为海量 3D 数据设计。
  - **核心文件**：`tileset.json`（描述树状索引结构）+ `.b3dm`（Batched 3D Model，含几何与属性）。
  - **优势**：支持空间索引，当你只看建筑的一角时，不会下载整个城市的模型。

### 3.3 室内矢量数据
- **GeoJSON**：适合轻量级室内图（如几千个房间）。
- **Vector Tiles (MVT)**：适合超大型商场或机场，二进制压缩，传输快。
- **IMDF (Apple Indoor Mapping Data Format)**：基于 GeoJSON 的行业标准，定义了 Level（楼层、Unit（房间）、Opening（门）等语义。

---

## 4. 坐标系的终极融合：从球心到局部

这是本课程最难、最易出错的环节。多尺度地图涉及三个坐标世界的碰撞。

### 4.1 统一的世界：ECEF 与 WGS84
Web 3D 引擎（如 Cesium）内部通常使用 **ECEF (Earth-Centered, Earth-Fixed)** 直角坐标系 $(X, Y, Z)$ 进行渲染，原点在地球质心。而我们的数据源（吉林一号、GPS）通常是 **WGS84 经纬度** $(\text{Lon}, \text{Lat}, \text{Alt})$。
- **转换公式**：引擎会自动处理经纬度到 ECEF 的转换，但你必须确保所有输入数据的水平基准是 WGS84（EPSG:4326）。

### 4.2 垂直基准的陷阱：椭球高 vs. 海拔高
- **问题**：卫星系统（GPS）使用的是**椭球高（Ellipsoidal Height）**，而 DEM 和工程图纸通常使用**正高/海拔高（Orthometric Height / Geoid Height）**（如 EGM96 模型）。
- **现象**：你的 BIM 模型可能会“悬浮”在半空，或者埋在地几十米。
- **Rule of Thumb**：
  > 在数据入库前，必须明确高程基准。如果引擎（如 Cesium）默认使用 WGS84 椭球体，你需要加载一个“大地水准面差距（Geoid Separation）”文件来修正海拔高，或者手动在 Z 轴添加偏移量。

### 4.3 BIM 的地理配准 (Georeferencing)
BIM 模型通常以 $(0,0,0)$ 为项目原点。将其放到地球上需要构建一个**变换矩阵 (Model Matrix)**。

该矩阵是一个 $4 \times 4$ 矩阵，包含：
1.  **平移 (Translation)**：将局部原点移到地球表面的目标经纬度位置 (ECEF)。
2.  **旋转 (Rotation)**：
    - 校正“上”方向（地球表面法线方向）。
    - 校正“北”方向（建筑物的方位角/朝向）。
3.  **缩放 (Scale)**：通常为 1:1（除非单位弄错了，米 vs 毫米）。

$$
M_{local \to world} = M_{translate} \times M_{rotate} \times M_{scale}
$$

---

## 5. 交互设计与应用逻辑

如何让用户在多尺度间不迷路？

### 5.1 视口控制策略
- **限制相机高度**：设置 `minHeight` 防止穿模到地表以下，设置 `maxHeight` 防止飞出太阳系。
- **惯性与阻尼**：在不同尺度调整鼠标滚轮的灵敏度。在太空时滚轮一下跨越 1000km，在室内时一下只跨越 1m。

### 5.2 室内模式切换逻辑 (Indoor Toggle)
当用户聚焦到某栋大楼时，UI 应发生变化：
1.  **触发**：用户点击建筑物，或 Zoom Level > 18 且相机俯角 < 45度。
2.  **动作**：
    - 隐藏该区域的覆盖物（如 3D Tiles 外壳），防止遮挡内部。
    - 显示右侧侧边栏“楼层选择器 (F1, F2...)”。
    - 加载该建筑的室内矢量图层。
3.  **剖切**：
    - 如果保留外壳，需启用“剖切平面（Clipping Plane）”，像切蛋糕一样切掉楼层上方的几何体，露出内部结构。

### 5.3 街景联动逻辑
- **分屏模式**：左侧 3D 地图，右侧全景图。
- **游标同步**：
  - 3D 地图上显示一个扇形图标（FOV），代表景相机的朝向。
  - 拖动全景图视角，地图上的扇形随之旋转。
  - 在全景图中点击“前进”，地图上的游标位置同步移动。

---

## 6. 实战流程：搭建全栈演示 (Demo)

假设我们要为某科技园区制作数字孪生底图。

### 第一步：底图与地形 (Global Setup)
1.  初始化 Web 3D 引擎（推荐 CesiumJS 以获得最佳地形支持）。
2.  配置 `ImageryProvider`：接入天地图 WMTS 服务（注记层 + 影像层）。
3.  配置 `TerrainProvider`：接入全球地形服务。
4.  **调试**：确保能看到带有起伏的山脉和正确贴合的中文地名注记。

### 第二步：城市精细化 (City Layer)
1.  获取园区及周边的吉林一号影像（GeoTIFF）。
2.  使用 `gdal2tiles` 或类似工具生成 TMS/XYZ 瓦片。
3.  发布为静态 Web 服务（Nginx/Apache）。
4.  在引擎中添加图层，设置 `rectangle` 范围（只在园区范围内加载，节省资源），并设置 `alpha` 透明度混合边缘使其自然融入天地图背景。

### 第三步：街景接入 (Street Level)
1.  准备一组全景照片（`.jpg`）和对应的元数据（CSV：文件名, lat, lon, heading, pitch）。
2.  在地图上渲染为一串“蓝色圆点”矢量要素。
3.  编写点击事件：点击圆点 -> 弹出 HTML `<div>` 容器 -> 初始化全景查看器（如 Photo Sphere Viewer） -> 加载对应图片。

### 第三步：室内透视 (Indoor Layer)
1.  **数据准备**：将 Revit 模型导出，简化为 GeoJSON（提取墙线、房间多边形）。
2.  **配准**：记录园区大楼中心点的精确经纬度。
3.  **开发楼层控件**：HTML 按钮组（1F, 2F...）。
4.  **渲染逻辑**：
    - 将 GeoJSON 加载为贴地矢量（Clamped to ground）。
    - 默认 `Show: false`。
    - 当楼层按钮点击时，设置对应楼层数据的 `Show: true`，并设置该图层的 `height`（海拔高度 = 地面海拔 + 楼层高度 * 3米）。

---

## 7. 常见陷阱与调试技巧 (Gotchas)

### 7.1 "Z-Fighting" (闪烁的面)
- **现象**：室内地板和吉林一号影像在疯狂闪烁，交替显示。
- **原因**：两个平面在数学上高度几乎一致，深度缓冲区（Depth Buffer）精度不足，无法判断谁在前。
- **Fix**：
  - **多边形偏移 (Polygon Offset)**：在渲染参数中强制让室内地板“在视觉上”前移。
  - **物理抬升**：将室内数据统一抬高 5~10 厘米。

### 7.2 纹理大爆炸 (OOM)
- **现象**：浏览器崩溃，显存溢出。
- **原因**：同时加载了过多的高分影像或精细模型。
- **Fix**：
  - **内存管理**：手动调用引擎的资源销毁方法（`destroy` 或 `remove`），当图层不可见时，彻底释放内存，而不仅仅是隐藏。
  - **纹理压缩**：使用 KTX2 / Basis Universal 等 GPU 友好的压缩纹理格式，可减少 70% 的显存占用。

### 7.3 "模型在飘" (The Floating Model)
- **现象**：缩放到底层时，发现建筑模型似乎在地面上滑动，没有钉死在某个位置。
- **原因**：通常是精度丢失（Jittering）。Web 渲染使用 Float32，而地球坐标数值巨大，导致小数点后精度不够。
- **Fix**：
  - 确保使用支持 **Relative-to-Center (RTC)** 或 **Double Precision** 渲染的现代引擎（如 Cesium 的 RTE 机制）。
  - 在生成 3D Tiles 时，确保设定了正确的 `RTC_CENTER`。

---

## 8. 本章小结

本章是所有前面知识的集大成者。我们打破了数据的孤岛，建立了一个多尺度的时空索引体系。

- **宏观上**，我们利用金字塔模型（LOD）解决了海量数据的传输问题。
- **微观上**，我们通过矩阵变换解决了 BIM 到 GIS 的坐标对齐问题。
- **交互上**，我们设计了从太空到室内的平滑过渡逻辑。

至此，你已经掌握了构建一个简易版“Google Earth”所需的完整技术链路。这是从一名 GIS 数据处理员向 WebGIS 全栈工程师跨越的关键一步。
