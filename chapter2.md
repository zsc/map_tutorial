# 第 2 章：矢量地图基础与空间分析

## 1. 开篇

在第一章中，我们建立了“地球是一个椭球体”的认知，并确立了坐标参照系（CRS）作为定位的基石。然而，坐标点 merely 是数字海洋中的孤岛。为了在计算机中重现现实世界的复杂性——描绘蜿蜒的河流、不规则的地块、错综复杂的路网——我们需要一种能够精确描述离散对象的数字模型：**矢量数据（Vector Data）**。

与照片式的栅格数据不同，矢量数据是**面向对象**的。它认为世界是由一个个独立的实体（Feature）组成的。本章将深入矢量数据的“解剖学结构”，从最基本的几何类型讲起，深入探讨文件存储的底层差异，剖析维持地图逻辑正确的“拓扑关系”，并详细拆解缓冲区、加分析等核心空间算法的几何原理。

**学习目标**：
1.  **深入理解几何模型**：掌握点、线、面及其“多部件（Multi-part）”变体，理解“岛”与“洞”的存储逻辑。
2.  **掌握数据格式本质**：透彻理解 Shapefile 的文件构造与局限，对比 GeoJSON 与 GeoPackage 的现代优势。
3.  **领会拓扑的重要性**：识别并理解悬挂节点、自相交、细长碎部（Sliver）等拓扑错误。
4.  **精通空间分析逻辑**：掌握缓冲区（Buffer）、叠置（Overlay）、空间连接（Spatial Join）的数学逻辑与应用场景。

---

## 2. 文字论述

### 2.1 矢量数据的解剖学：几何与属性

矢量数据模型（Vector Data Model）将地理空间实体抽象为**几何（Geometry）**与**属性（Attributes）**的结合体。

#### 2.1.1 几何基元（Geometry Primitives）

OGC（开放地理空间联盟）定义了简单的要素规范（Simple Feature Access），构成了所有 GIS 软件的基石除了基本的点线面，理解**多部件（Multi-part）**几何至关重要。

1.  **点 (Point)**
    *   **定义**：0 维几何，由一组坐标 $(x, y)$ 或 $(x, y, z)$ 确定。
    *   **多点 (MultiPoint)**：一行记录对应多个点。例如，“某连锁便利店的所有分店”作为一个整体要素存储。

2.  **线 (LineString / Polyline)**
    *   **定义**：1 维几何，由一系列有序的**节点 (Vertices)** 连接而成。
    *   **方向性**：线是有方向的（从起点 StartNode 到终点 EndNode）。这对于模拟水流、交通流向至关重要。
    *   **多线 (MultiLineString)**：例如“一条河流”可能中间断流，或者由多条支流组成，但在属性表中仍视为同一条河。

3.  **面 (Polygon)**
    *   **定义**：2 维几何，由一个或多个闭合的**线性环 (Linear Ring)** 组成。
    *   **外环与内环**：这是面要素最复杂的概念。一个多边形由一个**外环 (Exterior Ring)** 和零个或多个**内环 (Interior Rings)** 组成。内环即为“洞”。
        *   *例子*：一个湖泊（外环）中间有一个岛屿（岛屿本身是陆地，不属于湖泊多边形，所以在湖泊多边形中表现为一个“洞”）。
    *   **多面 (MultiPolygon)**：例如“日本”或“菲律宾”这样的群岛国家，由成千上万个分离的岛屿组成，但在数据库中，它是**一行**记录，对应一个 MultiPolygon。

```text
   [Polygon with Hole]              [MultiPolygon]
   
      ___________                    ______      ___
     /           \                  /      \    /   \
    /   Ext.      \                / Part 1 \  / Part\
   /    Ring       \              /__________\ \  2  /
  /     _____       \                           \___/
 |     | Int.|       |            (One Feature ID)
 |     | Ring|       |
 |     |_____|       |
 \                   /
  \_________________/
```

#### 2.1.2 属性表（Attribute Table）
属性是非空间信息，通常以关型数据库表的形式存在。每一行（Row）对应一个几何实体，每一列（Column）对应一个字段。
*   **连接关键**：几何与属性通常通过唯一的 `FeatureID` (FID) 绑定。
*   **数据类型**：包含整型、浮点型、字符串、日期等。

### 2.2 数据格式大比拼：从历史包袱到现代标准

#### A. Shapefile (.shp) —— 不死的传奇与噩梦
由 ESRI 在 90 年代初推出。它不是一个文件，而是一组文件（通常 3 到 8 个）。
*   `.shp`: 存储几何图形。
*   `.shx`: 几何图形的索引（用于快速跳转）。
*   `.dbf`: dBase 格式存储属性表（这是最大的痛点）。
*   `.prj`: 存储投影信息（WKT 文本）。

> **致命局限**：
> 1.  **字段名截断**：`.dbf` 限制字段名最长 **10 个字符**（例如 `construction_year` 会变成 `constructi`）。
> 2.  **文件大小**：`.shp` 和 `.dbf` 最大支持 **2GB**。
> 3.  **编码地狱**：`.dbf` 默认没有明确的编码声明，常导致中文乱码（GBK vs UTF-8）。
> 4.  **NULL 值**：很难区分“0”和“NULL”。

#### B. GeoJSON (.json) —— Web 的宠儿
基于 JSON 的纯文本格式，人类可读。
*   **结构**：由 `FeatureCollection` 包含 `Features`，每个 Feature 包含 `geometry` 和 `properties`。
*   **优点**：Web 原生支持（JavaScript 能够直接解析），无字段长度限制，强制 UTF-8。
*   **缺点**：体积臃肿（冗余的括号和键名）。不适合存储海量数据（解析慢）。

#### C. GeoPackage (.gpkg) —— 现代的终结者
基于 **SQLite** 数据库的单文件容器，OGC 标准。
*   **优点**：
    *   **单文件**：没有乱七八糟的同名文件。
    *   **无限制**：无 2GB 限制，无 10 字符字段名限制。
    *   **高性能**：内置 R-Tree 空间索引，读取速度极快。
    *   **混合存储**：同一个文件可以存矢量、栅格瓦片甚至非空间表。

> **Rule of Thumb (经验法则)**：
> *   **做分析、存数据**：永远首选 **GeoPackage**。
> *   **Web 前端展示/API 传输**：使用 **GeoJSON**（如果是大数据量传输，考虑 PBF/MVT 矢量瓦片，这将在后续章节介绍）。
> *   **客户交付**：如果客户老派，给 Shapefile（记得处理字段名缩写）；否则给 GeoPackage。

### 2.3 拓扑关系 (Topology)：数据的逻辑骨架

拓扑不仅仅是几何位置，它定义了空间对象之间的**连接**、**邻接**和**包含**关系。拓扑关系在地图发生弹性形变（如投影转换）时保持不变。

#### 为什么需要拓扑？
如果只是画图，不需要拓扑。但如果要做分析：
*   **导航**：如果道路在十字路口没有打断并共享节点，导航引擎会认为这里不能转弯（因为线不连通）。
*   **统计**：如果两个行政区划面之间有重叠，计算总面积时就会重复统计。

#### 常见的拓扑错误与图示

1.  **悬挂节点 (Dangle / Overshoot / Undershoot)**
    线段超出了目线或未到达目标线。
    ```text
    Target Line:  ───────────────
    Overshoot:           |
                         | (Crosses over)
                      ───|───
                      
    Undershoot:          |
                         | (Gap)
                         |
    ```

2.  **自相交 (Self-intersection / Bowtie)**
    多边形的边界线自己切自己，形成类似领结的形状。这在几何计算（如面积）时会导致数学错误。
    ```text
       Geometry:      / \
                     /   \
                    /  X  \   <-- Intersection Point
                   / /   \ \
                  /_/     \_\
    ```

3.  **碎部多边形 (Slivers)**
    两个本该公共边的多边形之间，因为数字化误差，产生细长的重叠或空隙。
    ```text
       Poly A      / \ / \      Poly B
      ____________/   X   \_____________
                  \_______/
                 (Tiny gap or overlap)
    ```

### 2.4 核心空间分析逻辑

#### A. 缓冲区分析 (Buffering)
不仅是画个圈。缓冲区的本质是 Minkowski Sum（闵可夫斯基和）。
对于点 $P$ 和半径 $r$，缓冲区是圆。对于复杂多边形，它是多边形边界上每个点做圆后的包络线。

*   **端点样式 (End Cap Style)**：在线的末端，是圆头 (Round)、平头 (Flat/Butt) 还是方头 (Square)？这对路网分析很重要。
*   **侧边缓冲 (Single-sided Buffer)**：只在道路左侧做缓冲（例如分析左侧扩建影响）。

#### B. 叠置分析 (Overlay Operations)
基于集合论的布尔运算。

*   **裁剪 (Clip)**: $Result = Input \cap ClipLayer$。
    *   只保留几何形状，**属性不融合**。仅仅是物理形状的切割。
*   **相交 (Intersect)**: $Result = LayerA \cap LayerB$。
    *   保留几何重叠部分，且**属性表融合**（Join）。
*   **联合 (Union)**: $Result = LayerA \cup LayerB$。
    *   保留所有几何，重叠部分会被切割出来成为独立要，属性包含两者。
*   **擦除 (Difference)**: $Result = LayerA - LayerB$。

#### C. 空间连接 (Spatial Join)
GIS 中最强大的工具之一。将“位置关系”转化为“属性关联”。
*   **点在面内 (Point in Polygon)**：给“学校”点数据加上“所在城市”的属性。
*   **总结式连接 (Summary Join)**：
    *   问题：每个行政区有多少个学校？学校总人数多少？
    *   操作：将“学校”（多）Join 到“行政区”（一）。
    *   逻辑：`Count`（计数），`Sum`（求和）。

---

## 3. 本章小结

1.  **数据模型**：矢量数据由**几何**（点、线、面及其多部件变体）和**属性**（表格数据）组成。
2.  **格式进化**：**GeoPackage** 是现代 GIS 交互与存储的标准容器，它解决了 **Shapefile** 的字段截断、大小限制和编码问题。Web 开发则依赖 **GeoJSON**。
3.  **拓扑完整性**：高质量的地图不仅看起来没问题，逻辑上也不能有**悬挂**、**自相交**和**缝隙**。拓扑检查是数据入库前的必修课。
4.  **空间逻辑**：
    *   **缓冲区**描述影响范围。
    *   **叠置分析**（裁剪/相交）处理层与层的几何关系。
    *   **空间连接**利用位置关系进行数据融合与统计。

---

## 4. 常见陷阱与错误 (Gotchas)

### 💀 陷阱 1：投影单位导致的“巨大”或“微小”缓冲区
*   **现象**：设定 500 缓冲距离，结果生成了覆盖全球的面。
*   **原因**：数据处于 **WGS84 (EPSG:4326)** 地理坐标系，单位是**度**。GIS 软件机械地执行了 “500 度”的缓冲。
*   **解决方案**：先将数据 `Reproject` 到投影坐标系（如 UTM 或 Web Mercator），使单位变为**米**，再做缓冲。

### 💀 陷阱 2：CSV 导入时的经纬度翻转
*   **现象**：点落在了南极或索马里海域（本来应该在中国）。
*   **原因**：混淆了 `Lat/Lon` 和 `X/Y`。
*   **记忆口诀**：
    *   **X = Longitude (经度)**：在地图上横向移动，范围 -180 ~ 180。
    *   **Y = Latitude (纬度)**：在地图上纵向移动，范围 -90 ~ 90。
    *   大部分 GIS 软件导入需要 **X, Y** 顺序，而 Google Maps API 等常说 **Lat, Lon**。**Lat is Flat** (纬度是横线，对应 Y 轴)。

### 💀 陷阱 3：MultiPolygon 变 Polygon 的丢失
*   **现象**：对一个国家做处理后，发现岛屿都丢了，只剩下最大的陆地块。
*   **原因**：某些陈旧的处理函数或格式转换（如转为仅支持单一部件的旧格式）强行将 `MultiPolygon` 拆解或只保留了面积最大的部分（Cast to Single）。
*   **调试**：始终检查几何类型是否为 `Multi`，并在处理时允许 Multipart 几何。

### 💀 陷阱 4：Shapefile 编码灾难
*   **现象**：打开 Shapefile 属性表，中文全是 `Åäö...` 乱码。
*   **原因**：`.cpg` 文件缺失，或者软件默认用 System Locale (GBK) 去读 UTF-8 的数据（反之亦然）。
*   **调试**： QGIS 打开时显式指定 Encoding（如 GBK, UTF-8, Big5）。保存时**务必**转存为 UTF-8 的 GeoPackage 以永绝后患。

### 💀 陷阱 5：环的方向 (Ring Orientation)
*   **现象**：在某些 WebGL 引擎或数据库中，多边形不显示，或者显示为“除了这个多边形以外，整个地球都被填充了”。
*   **原因**：根据 OGC Simple Feature 标准，外环应为**逆时针 (CCW)**，内环为**顺时针 (CW)**。如果方向反了，渲染引擎可能将其理解为“这是一个包含了整个地球、挖掉了中间一小块”的超大多边形。
*   **调试**：使用 `Force Right-Hand-Rule` 或 `Repair Geometry` 工具修复顶点的缠绕顺序。

---

[< 上一章：地图世界观](chapter1.md) | [下一章：栅格影像与遥感入门 >](chapter3.md)
