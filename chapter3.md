# 第 3 章：栅格影像与遥感入门（含多光谱）

## 1. 开篇段落

在上一章中，我们用矢量勾勒了世界的轮廓。然而，矢量数据是对现实的高度抽象，它丢弃了大量的环境细节。如果我们想知道“那片森林有多健康？”、“那个屋顶是什么材质？”或者“洪水淹没了多少农田？”，矢量数据往往无能为力。这时，我们需要进入**栅格数据（Raster Data）**的领域。

栅格影像不仅仅是“天上的照片”。对于 GIS 和遥感工程师而言，它们是**主要的数据源**。每一幅卫星影像本质上都是一个巨大的科学测量矩阵，记录了地表反射太阳光谱的物理量。本章将带你深入理解栅格数据的解剖结构，从空间分辨率到辐射分辨率，从简单的 RGB 合成到复杂的波段运算。你将掌握如何利用不可见光（如近红外）来解译地表特征，理解现代 Web 地图如何利用“瓦片金字塔”技术流畅传输海量影像，并为后续使用 Sentinel、Landsat 和吉林一号数据打下坚实的理论基础。

---

## 2. 栅格数据的解剖学

### 2.1 空间分辨率：像素与现实的映射

栅格数据的基本单元是**像素（Pixel/Cell）**。每一个像素都代表了地球表面上的一个矩形区域。描述这个精度的核心指标是**地面采样距离（Ground Sample Distance, GSD）**。

#### 分辨率层级与应用场景
不同的 GSD 决定了你能“看清”什么：

1.  **亚米级（< 1m, e.g., 吉林一号, WorldView, Google Earth）**
    *   **能力**：能看到车辆、人行横道、树冠形状，甚至由于视角造成的建筑物倾斜。
    *   **代价**：数据量其庞大，覆盖全球极其昂贵，通常只针对城市或特定目标采集。
2.  **中高分辨率（10m - 30m, e.g., Sentinel-2, Landsat）**
    *   **能力**：能看清路网骨架、大型建筑群、农田边界。虽然看不清汽车，但能完美监测森林砍伐、湖泊面积变化。
    *   **优势**：由于数据量适中且重访周期短（几天一次），是**全球监测**的主力军，且多为免费开源。
3.  **低分辨率（250m - 1km, e.g., MODIS, NOAA）**
    *   **能力**：只能看到宏观地貌，如台风云系、大范围积雪、大陆级植被变化。

> **Rule of Thumb (分辨率法则)：**
> 想要识别一个物体，像素大小最好至少是该物体尺寸的 **1/2 到 1/3**。
> *   识别一辆 4.5m 长的轿车 -> 需要优于 2m 的分辨率。
> *   看清车是两厢还是三厢 -> 需要优于 0.5m 的分辨率。

### 2.2 辐射分辨率：位深 (Bit Depth) 与直方图

我们平时接触的 JPG 图片是 **8-bit** 的，每个通道值在 0-255 之间。但在科学遥感中，这远远不够。

#### 为什么需要 12-bit 或 16-bit？
地球表面的亮度差异极大。雪山的反射极其强烈，而深海或阴影下的森林反射极其微弱。
- 如果用 8-bit（256 个刻度）记录，深色区域可能都被压缩成 0（纯黑），亮处都变成了 255（过曝）。
- 卫星传感器通常使用 **11-bit, 12-bit (0-4095) 或 16-bit (0-65535)** 进行记录。这不仅是为了“更亮”，而是为了**更高的动态范围（Dynamic Range）**，确保在阴影和高光区都能保留细节。

#### 直方图（Histogram）的重要性
当你打开原始卫星影像时，往往是一片漆黑。这不是数据坏了，而是因为数据分布在低值区间。
- **DN 值 (Digital Number)**：传感器记录的原始数值。
- **拉伸 (Stretch)**：为了显示，我们需要将集中在低值区（例如 200-3000）的数据，线性映射到屏幕显示的 0-255 区间。这是 GIS 软件中最常用的可视操作。

### 2.3 数据的物理意义：从 DN 到 SR

卫星影像的处理不仅仅是修图，而是物理校正的过程。理解以下三个层级至关重要：

1.  **Level 0 / Level 1 (Raw/DN)**：传感器记录的原始电压/计数值。包含几何畸变，无法直接用于地理分析。
2.  **TOA (Top of Atmosphere - 大气层顶反射率)**：经过几何校正，将 DN 值转换为反射率。但这包含了大气层（云、气溶胶、瑞利散射）的干扰。看起来就像蒙了一层蓝紫色的雾。
3.  **BOA / SR (Bottom of Atmosphere / Surface Reflectance - 地表反射率)**：通过算法（大气校正）去除了大气的干扰。这是**做科学分析（如计算 NDVI）的标准数据源**。

---

## 3. 多光谱遥感：超越人眼的物理探测

普通相机记录可见光（Visible: Red, Green, Blue），而多光谱卫星（Multispectral）记录的是更宽广的电磁波谱。

### 3.1 关键波段解析

理解波段是理解遥感的核心。以下是 Sentinel-2 或 Landsat 等卫星的标准配置：

*   **可见光波段 (Visible)**
    *   **Blue (~490nm)**：穿透水体能力最强，对大气散射最敏感（所以天空是蓝的）。
    *   **Green (~560nm)**：对应植被反射峰值（叶绿素），用于评估植被活力。
    *   **Red (~665nm)**：植被吸收最强的波段之一（光合作用原料），也是区分土壤与植被的关键。

*   **近红外波段 (NIR, ~840nm)**
    *   **特性**：这是遥感之王。健康的绿色植被细胞结构会强烈反射 NIR，反射率通常 > 40%，而红光反射率可能 < 5%。
    *   **用途**：生物量监测、水体边界识别（水体强烈吸收 NIR，呈黑色）。

*   **短波红外 (SWIR, > 1600nm)**
    *   **特性**：对水分含量非常敏感。
    *   **用途**：穿透烟雾（火灾监测）、区分云和雪、岩石矿物识别、土壤湿度监测。

### 3.2 波段组合 (Band Combinations)

通过将不同的波段映射到屏幕的 R、G、B 通道，我们可以制造出强化特定特征的“假彩色”图像。

| 组合名称 | R 通道映射 | G 通道映射 | B 通道映射 | 效果与用途 |
| :--- | :--- | :--- | :--- | :--- |
| **真彩色 (True Color)** | Red | Green | Blue | 模拟人眼视觉，适合底图展示。但受大气雾霾影响大，对比度通常较低。 |
| **标准假彩色 (CIR)** | **NIR** | Red | Green | **植被呈鲜红色**。这是最经典的遥感组合，极易区分健康植被（亮红）、稀疏植被（淡红）和人工建筑（青灰）。 |
| **农业/短波红外** | **SWIR** | **NIR** | Blue | 植被呈亮绿色，裸土呈品红色。穿透薄雾能力强，常用于农作物监测和火点识别。 |

### 3.3 光谱指数：让数学说话

指数运算的核心思想是：**归一化差值**。通过 $(A-B)/(A+B)$ 的形式，可以消除由于地形起伏（阴影）或太阳高度角不同带来的光照不均匀影响，只保留地物本身的光谱差异。

#### 1. 归一化植被指数 (NDVI)
$$
NDVI = \frac{NIR - Red}{NIR + Red}
$$
*   **原理**：利用植被“高反 NIR，强吸 Red”的特性。
*   **应用**：全球最通用的植被健康度指标。

#### 2. 归一化水体指数 (NDWI)
$$
NDWI = \frac{Green - NIR}{Green + NIR}
$$
*   **原理**：水体在可见光有反射，但在近红外几乎完全吸收。植被和土壤则相反。
*   **应用**：洪水淹没范围提取、湖泊边界勾绘。

#### 3. 归一化建筑指数 (NDBI)
$$
NDBI = \frac{SWIR - NIR}{SWIR + NIR}
$$
*   **原理**：城市不透水面（混凝土、沥青）在 SWIR 波段的反射率通常高于 NIR。
*   **应用**：城市扩张监测。

---

## 4. 现代栅格数据工程：存储与 Web 发布

处理完数据后，如何让用户在浏览器中流畅查看 100GB 的全球影像？答案在于**分块**与**金字塔**。

### 4.1 瓦片金字塔 (Tile Pyramid) 机制

Web 地图（如 Google Maps, 天地图）不传输整张图片，而是传输 $256 \times 256$ 像素的小图片（瓦片。

#### 金字塔层级 (Zoom Levels)
*   **Level 0**：1 张瓦片覆盖全世界。
*   **Level 1**：$2 \times 2 = 4$ 张瓦片。
*   ...
*   **Level $n$**：$2^n \times 2^n$ 张瓦片。

#### 坐标索引 (XYZ vs TMS)
每个瓦片通过 $(x, y, z)$ 唯一索引。
*   $z$：缩放级别。
*   $x$：列号（从左到右）。
*   $y$：行号。**注意陷阱**：
    *   **Google / OSM / XYZ 标准**：原点在左上角（北纬 85度，西经 180度），Y 向下增加。
    *   **TMS (Tile Map Service) / OSGeo 标准**：原点在左下角，Y 向上增加。

> **数学公式：瓦片数量爆炸**
> 18 级（街道级）的全球瓦片总数约为：
> $$ \text{Total Tiles} = \sum_{z=0}^{18} 4^z \approx \frac{4^{19}-1}{3} \approx 2.3 \times 10^{11} \text{ (两千三百亿张)} $$
> 这就是为什么要按需切片或动态渲染，而不是预先生成所有瓦片。

### 4.2 云原生数据格式：COG (Cloud Optimized GeoTIFF)

在过去，使用 TIFF 必须下载完整个文件才能取。现在，行业标准是 **COG**。

*   **内部结构**：COG 是一个合法的 GeoTIFF，但它强制要求：
    1.  **分块存储 (Tiled)**：内部像素数据被切成小块（如 $512 \times 512$）。
    2.  **概览图 (Overviews/IFD)**：在文件头内部预先计算好了不同缩放比例的缩略图。
    3.  **HTTP Range Requests**：支持该协议的软件（如 QGIS, GDAL, 浏览器 JS 库）可以只向服务器请求文件特定字节范围的数据。
*   **结果**：你可以在 QGIS 中打开一个存储在 AWS S3 上 50GB 的 COG 文件，瞬间看到全图预览，放大时只下载视口内的数据流，无需下载源文件。

---

## 5. 本章小结

1.  **栅格即矩阵**：栅格数据是记录地表信息的像素矩阵，核心指标是**GSD（空间分辨率）**和**位深（辐射分辨率）**。
2.  **多光谱原理**：不同地物在不同波段反射率不同。**NIR（近红外）**是植被监测的关键，**SWIR（短波红外）**穿透力强且对水敏感。
3.  **指数分析**：通过 **NDVI**, **NDWI** 等归一化指数运算，可以消除光照影响，定量提取植被和水体特征。
4.  **物理校正**：专业分析应尽量使用 **SR（地表反射率）** 级别的数据，而非原始 DN 值。
5.  **Web 分发**：利用**瓦片金字塔 (XYZ)** 和 **COG** 技术，解决了海量栅格数据在网络上的传输效率问题。

---

## 6. 常见陷阱与错误 (Gotchas)

### 6.1 "全黑"与"全白"的显示问题
*   **现象**：打开影像全黑或全白，或者颜色非常怪异。
*   **原因**：
    1.  **位深未拉伸**：16-bit 数据直接用 8-bit 显示器显示。
    2.  **NoData 干扰**：影像边缘的黑色背景（NoData）被当作真实值 0 参与了直方图统计，导致真实数据的对比度极低。
*   **调试**：在 GIS 软件中设置 "Ignore NoData" 并重新计算直方图（Min-Max Stretch 或 2% Cumulative Cut）。

### 6.2 混淆波段顺序 (RGB Mapping)
*   **现象**：森林成了蓝色，城市变成了红色。
*   **原因**：不同卫星的波段编号不同。
    *   **Sentinel-2**：Red=B4, Green=B3, Blue=B2, NIR=B8
    *   **Landsat 8/9**：Red=B4, Green=B3, Blue=B2, NIR=B5
    *   **Landsat 7**：Red=B3, Green=B2, Blue=B1, NIR=B4
*   **对策**：永远先查阅该卫星的 "Band Designations" 文档。

### 6.3 投影转换中的重采样失真
*   **现象**：分类结果出现原本不存在的颜色，或者分类边缘模糊。
*   **原因**：在重投影（例如 WGS84 转 Web Mercator）时，默认使用了**双线性插值 (Bilinear)** 或 **三次卷积 (Cubic)**。这对于连续影像（如照片）很好，但对于**离散数据（如土地分类图，1=林地，2=水体）**是灾难性的，因为插值会算出 1.5 这种不存在的类别。
*   **对策**：
    *   **连续数据（影像/DEM）**：用 Bilinear/Cubic/Lanczos（平滑）。
    *   **分类/离散数据**：必须用 **Nearest Neighbor（最近邻）**。

### 6.4 云的干
*   **现象**：NDVI 计算结果局部异常低，或者目标检测出现大量误报。
*   **原因**：光学卫星无法穿透云层。云的反射率极高（亮白），云影则是纯黑。
*   **对策**：使用 QA 波段（Quality Assessment band）生成的**云掩膜 (Cloud Mask)** 剔除坏点，或者改用 SAR（合成孔径雷达）数据（后续章节介绍）。
