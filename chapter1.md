# 第 1 章：地图世界观——从地球到屏幕

## 1. 开篇
在构建任何复杂的地图应用（无论是全球可视化、城市规划还是街景导航）之前，我们需要回答一个最基本的问题：**如何将一个凹凸不平的三维球体（地球），精准地“压”进二维的计算机屏幕和数据结构中？**

这一章是整个课程的基石。我们不会一开始就陷入复杂的算法，而是建立正确的“地图世界观”。我们将探讨地球的真实形状、如何通过数学投影将其展开、矢量与栅格这两种描述世界的根本方式，以及在 Google Maps、天地图等现代 Web 地图中普遍使用的“缩放级别”概念。

**本章学习目标：**
1. 理解大地水准面、参考椭球与基准面（Datum）的关系。
2. 掌握 WGS84 (EPSG:4326) 与 Web Mercator (EPSG:3857) 的核心区别与转换辑。
3. 深刻理解矢量数据与栅格数据的本质差异及适用场景。
4. 熟悉 Web 地图金字塔模型（Zoom Levels）与分辨率（GSD）的换算法则。
5. 学会在桌面 GIS 软件中建立第一个“正确投影”的工程。

---

## 2. 核心论述

### 2.1 地球的形状：不仅仅是一个球
我们常把地球想象成一个完美的球体，但在测绘学和高精度地图中，地球更像一个“土豆”。为了数学计算方便，我们需要三个层面的抽象：

1.  **自然表面 (Topography)**：真实的地球表面，有山脉、海沟，无法用简单公式描述。
2.  **大地水准面 (Geoid)**：假设海洋静止并延伸穿过陆地，由重力等势面形成的形状。它依然起伏不平。
3.  **参考椭球体 (Reference Ellipsoid)**：为了测量和计算，人为定义的一个规则的、旋转椭球面，最接近大地水准面。

> **Rule of Thumb (经验法则)**：
> 在做普通的 Web 地图或导航时，我们通常假设地是一个**椭球体**（如 WGS84 椭球）。但在进行海拔高程处理（如水流分析）时，必须考虑**大地水准面**，否则水可能会“往高处流”。

### 2.2 坐标系与投影：给地球穿上经纬网

有了椭球体，我们需要通过**坐标系 (CRS)** 来定位，通过**投影 (Projection)** 来画图。

#### 2.2.1 地理坐标系 (Geographic CRS)
直接用经度 (Longitude) 和纬度 (Latitude) 来表示位置。
- **典型代表**：WGS84 (EPSG:4326)
- **单位**：度 (Degrees)
- **特点**：它是三维空间在球面的直接表达，**不是**平面坐标。

#### 2.2.2 投影坐标系 (Projected CRS)
将球面“撕开”铺平。最著名的是墨卡托投影（Mercator）。
- **典型代表**：Web Mercator (EPSG:3857 / Pseudo-Mercator)
- **单位**：米 (Meters)
- **特点**：Google Maps, Bing, OSM, 天地图（球面墨卡托版）均采用此标准。它保持了方向和形状的局部正确性（正形投影），但高纬度地区面积变形严重（格陵兰岛看起来和非洲一样大）。

**ASCII 图解：投影的过程**
```text
      (灯光源)
         *
         |
    [ 地球球体 ]  --->  [ 圆柱体包裹 ]  --->  [ 展开成平面 ]
       /   \             |       |            __________
      (Lat,Lon)          |_______|           |          |
      WGS84              投影面接触           |  地图    |
                                             |__________|
                                             Web Mercator
                                               (X, Y)
```

#### 2.2.3 核心数学逻辑
从经纬度 $(\lambda, \phi)$ 到 Web Mercator $(x, y)$ 的变换并非简单的线性拉伸，涉及到自然对数运算以保证角度不变形：

$$
x = R \cdot \lambda
$$

$$
y = R \cdot \ln\left[\tan\left(\frac{\pi}{4} + \frac{\phi}{2}\right)\right]
$$

其中 $R$ 为地球半径。这解释了为什么纬度越高，$y$ 值增长越快，导致高纬度拉伸。

### 2.3 描述世界的两种语言：矢量 vs 栅

在地图数据中，一切皆可归为两类。

| 特性 | **矢量 (Vector)** | **栅格 (Raster)** |
| :--- | :--- | :--- |
| **基本单元** | 点、线、面 (几何数学描述) | 像素 (网格矩阵) |
| **典型数据** | 道路中线、行政区划、POI 点、BIM | 卫星影像、航拍图、DEM (高程) |
| **缩放表现** | 无限放大不失真，边缘始终平滑 | 放大后出现马赛克 (锯齿) |
| **文件体积** | 通常较小，取决于几何复杂度 | 通常较大，取决于分辨率和范围 |
| **查询能力** | "这是什么？" (属性表查询) | "这里有什么值？" (光谱/高程值) |

> **Rule of Thumb (经验法则)**：
> - 如果你的对象有明确的边界（如房子、地块），首选**矢量**。
> - 如果你的对象是连续变化的场（如温度、降雨、地形高程、地表颜色），首选**栅格**。

### 2.4 分辨率与缩放级别 (Zoom Level)

在 Google Maps 或天地图中，地图被切分为无数个正方形的“瓦片 (Tiles)”。

- **Level 0**：1 张瓦片覆盖整个世界（通常是 $256 \times 256$ 像素）。
- **Level 1**：4 张瓦片 ($2 \times 2$)。
- **Level $n$**：$2^n \times 2^n$ 张瓦片。

**地面分辨率 (GSD - Ground Sample Distance)** 指的是一个像素代表实际地面的多少米。它随纬度变化，但在赤道处有一个简单的计算公式：

$$
\text{GSD (meters/pixel)} \approx \frac{2 \pi R}{256 \cdot 2^{\text{zoom}}}
$$

其中 $2 \pi R$ 是赤道周长（约 40,075,016 米）。

- **Zoom 0**: ~156,543 米/像素 (看全球)
- **Zoom 10**: ~152 米/像素 (看城市轮廓)
- **Zoom 18**: ~0.6 米/像素 (看清楚车道线，吉林一号/高分影像常用级别)
- **Zoom 20**: ~0.15 米/像素 (看清楚人行道地砖，无人机/街景级别)

---

## 3. 实战指南：桌面端 GIS 初体验

尽管本课程不写代码，但我们需要通过工具来直观感受上述理论。推荐使用 **QGIS** (开源) 或 ArcGIS。

**操作演练思路：**

1.  **加载底图**：在 QGIS 浏览器面板中找到 `XYZ Tiles`，双击 `OpenStreetMap`。
    *   *观察*：右下角的坐标系代码会自动变成 `EPSG:3857`。鼠标在地图上移动，坐标单位是“米”，数值非常大（如 x: 12,000,000）。
2.  **更改工程坐标系**：点击右下角 `EPSG:3857`，将其改为 `EPSG:4326 (WGS 84)`。
    *   *现象*：地图瞬间变形，变得“扁”了。
    *   *原因*：软件现在直接把经纬度当做平面坐标画图（Equirectangular projection 效果），不再进行墨卡托拉伸。鼠标坐标变成了“度”（如 Lon: 116.4, Lat: 39.9）。
3.  **加载矢量与栅格**：
    *   拖入一个 `.shp` 或 `.geojson` 文件（矢量）。放大观察，边缘锐利。
    *   拖入一个 `.tif` 文件（栅格）。放大观察，最终会看到方块像素。

这一步操作是理解“数据本身坐标系”与“显示坐标系”分离的关键。

---

## 4. 本章小结

1.  **地球模型**：从大地水准面抽象到椭球体，再过投影展平。
2.  **两大标准**：
    *   **EPSG:4326** (WGS84)：数据的**存储**标准，用经纬度。
    *   **EPSG:3857** (Web Mercator)：Web 地图的**展示**标准，用米。
3.  **数据形态**：矢量描述离散对象（无限缩放），栅格描述连续空间（受分辨率限制）。
4.  **多尺度**：地图是通过“金字塔”切片组织的，Zoom Level 每增加 1，分辨率精细度翻倍，数据量变为 4 倍。

---

## 5. 常见陷阱与错误 (Gotchas)

### 陷阱 1：经纬度顺序混乱 (Lat/Lon vs. Lon/Lat)
这是 GIS 领域最经典的错误。
- **数学/GIS 传统**：X 轴是经度 (Lon)，Y 轴是纬度 (Lat)。格式为 `(Lon, Lat)`。
- **导航/Google Maps API**：习惯先说纬度。格式为 `(Lat, Lon)`。
- **调试技巧**：如果你的点飞到了索马里附近（Lat 0, Lon 0 附近）或者南极，首先检查是不是把经纬度写反了。如果纬度大于 90，程序通常会直接报错，因为纬度范围只有 -90 到 90

### 陷阱 2：在 Web Mercator 上测量距离
**永远不要**直接在 Web Mercator (EPSG:3857) 投影平面上用勾股定理计算两点距离。
- **原因**：墨卡托投影在高纬度拉伸严重，导致测量出的距离比实际长得多。
- **解决**：必须将坐标转回球面坐标（EPSG:4326），使用 **Haversine 公式** 或测地线距离算法计算；或者重投影到当地的等距投影系（如 UTM）后再计算。

### 陷阱 3：栅格影像的黑边 (NoData)
当你将一张矩形的卫星影像从一个坐标系转换到另一个坐标系（如 WGS84 转 Web Mercator），图像会发生旋转或扭曲。
- **现象**：图像周围出现黑色的三角形或锯齿状边缘。
- **处理**：这被称为 NoData 值。在处理流程中需要显式标记这些像素为透明（Alpha = 0）或特定的 NoData 值（如 -9999），否则渲染时会出现难看的黑框。

### 陷阱 4：混淆分辨率与精度
- **分辨率 (Resolution)**：像素代表多大面积（如 0.5米/像素）。
- **精度 (Accuracy)**：像素的位置是否准确（例如，这个像素里的房子，实际上是否真的在这个经纬度，还是偏了 5 米？）。
- **注意**：你可以把一张低精度地图强行插值放大的很高分辨率，但它的位置精度依然很差。不要盲目相信高 Zoom Level 的数据就是准的。
