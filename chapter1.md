# 第 1 章：地图世界观——从地球到屏幕

## 1. 开篇

当我们打开 Google Maps 或天地图，输入目的地开始导航时，屏幕上流畅滑动的地图背后，隐藏着人类数百年来试图解决的一个核心矛盾：**如何在一个平面的、有限的屏幕上，精确描述一个不规则的、三维的地球？**

这一章不是枯燥的地理课，而是构建数字地图系统的底层物理逻辑。如果不理解底层的“参考系”与“投影”，你后续制作的地图可能会出现数百米的偏差，或者在计算面积时产生巨大的谬误。我们将从大地测量学的基本原理出发，一路推演到现代互联网地图通用的“瓦片金字塔”模型。

**本章学习目标：**
1.  **破解地球形状**：深入理解大地水准面 (Geoid) 与参考椭球 (Ellipsoid) 的物理意义与工程妥协。
2.  **掌控坐标系**：彻底厘清基准面 (Datum) 的作用，以及 EPSG:4326 与 EPSG:3857 的本质区别。
3.  **数据二元论**：从数据结构层面剖析矢量与栅格的优劣，以及它们在存储与计算上的权衡。
4.  **多尺度思维**：掌握 Web 地图的“瓦片模型” (Tile Pyramid) 与四叉树索引，理解分辨率 (GSD) 与缩放级别 (Zoom) 的数学关系。
5.  **建立空间直觉**：学会判断什么是“投影变形”，并在 GIS 软件中建立正确的工程环境。

---

## 2. 核心论述

### 2.1 地球的真身：不规则的“土豆”与数学的妥协

地球并不是圆的，甚至不是一个标准的椭球。由于地壳密度不均，地球各处的重力场并不一致。

#### 2.1.1 大地水准面 (The Geoid)
如果我们移除潮汐和风浪的影响，让海水在重力作用下静止并延伸穿过陆地，形的一个封闭曲面，就是**大地水准面**。
- **物理意义**：它是重力的等势面。在这个面上，水不会流动。
- **形状**：极其不规则，像一个坑坑洼洼的土豆。在印度洋南部有个大坑，在北大西洋有个凸起。
- **作用**：它是测量**海拔高程**（MSL, Mean Sea Level）的基准零点。

#### 2.1.2 参考椭球体 (Reference Ellipsoid)
大地水准面太复杂，无法用简单的数学公式描述。为了进行 GPS 定位和地图绘制，我们必须用一个规则的旋转椭球去拟合它。
- **参数**：由长半轴 $a$（赤道半径）和扁率 $f$ 定义。
- **WGS84 椭球**：目前全球定位系统（GPS）使用的标准。
    - 长半轴 $a \approx 6,378,137.0$ 米
    - 扁率 $f \approx 1/298.257223563$

> **Rule of Thumb (经验法则) —— 高程的陷阱**：
> GPS 接收机（如手机）原生测量的通常是“椭球高”（相对于 WGS84 椭球面的高度）。而我们在地图上看到的、以及工程测量中使用的通常是“海拔高”（相对于大地水准面）。
> $$ \text{椭球高} = \text{海拔高} + \text{大地水准面差距 (Geoid Height)} $$
> 两者在全球范围内的差异可达 -100米 到 +80米。**做无人机航测或地形分析时，必须确认高程基准！**

---

### 2.2 坐标系：给地球穿上经纬网

#### 2.2.1 基准面 (Datum) —— 坐标系的“锚点”
仅仅有椭球是不够的，我们还需要把这个椭球“固定”在地球的某个位置。
- **地心基准面**：椭球中心与地球质心重合（如 WGS84, NAD83）。适合全球地图。
- **区域基准面**：为了让某个特定区域（如北京或东京）拟合得更准，人为移动椭球球心，使其表面紧贴该区域的大地水准面（如北京54坐标系）。

> **关键概念**：如果你把 WGS84 的经纬度直接套用到使用“北京54”基准面的地图上，可能会产生几十米甚至上百米的偏移。这就叫 **Datum Shift**。

#### 2.2.2 投影 (Projection) —— 撕开橘子皮
将三维球面转换到二维平面的过程叫投影。**所有投影都会变形**，只是选择保留什么属性（面积、角度、距离）的权衡。

**Web 地图的霸主：Web Mercator (EPSG:3857)**
Google Maps 在 2005 年做出了一个改变世界的决定：使用墨卡托投影。

*   **正形性 (Conformality)**：它保留了角度。如果你在路口需要转弯 90 度，地图上画的也是 90 度。这对于导航至关重要。
*   **计算效率**：它将世界裁剪为一个正方形。赤道周长 $\approx 40,075$ km，它强行把纬度限制在 $\approx \pm 85.05^\circ$，使得 Y 轴长度等于赤道周长。
*   **巨大的代价**：面积严重扭曲。格陵兰岛（216万 $km^2$）在地图上看起来和非洲（3037万 $km^2$）一样大。

**ASCII 图解：Web Mercator 的网格变形**
```text
纬度 60度 |  +------+------+  <-- 实际地面长度只有赤道的一半，
          |  |      |      |      但在图上被拉成同样宽度。
          |  | Grid | Grid |      (面积放大 4 倍)
          |  |      |      |
赤道 0度  |  +------+------+  <-- 基准宽度
          |  |      |      |
          |  |      |      |
          |  WGS84 (Lon) -> 
```

#### 2.2.3 常用 EPSG 代码速查
OGP（油气生产商协会）维护了一个庞大的参数注册表，称为 EPSG 代码。
- **EPSG:4326**: WGS84 地理坐标系。单位：度。**（存储数据的通用语）**
- **EPSG:3857**: Web Mercator 投影坐标系。单位：米。**（Web 展示的通用语）**
- **EPSG:326xx / 327xx**: UTM 投影。将地球切成 60 个竖条，精度高，变形小。**（工程测量、无人机高精度制图首选）**

---

### 2.3 描述世界的两种语言：矢量 vs 栅格

GIS 数据的本质只有两种：离散的对象与连续的场。

#### 2.3.1 矢量数据 (Vector)
用数学几何描述世界。
- **模型**：
    - **点 (Point)**：POI、树木、路灯。（0维）
    - **线 (LineString)**：道路、流中线、轨迹。（1维）
    - **面 (Polygon)**：建筑物轮廓、行政区划、湖泊。（2维）
- **拓扑关系 (Topology)**：矢量的高级形态。不仅记录“在哪里”，还记录“谁和谁相连”、“谁在谁左边”。这对于路径规划（导航）至关重要。
- **优势**：无限缩放不失真，数据量小，易于属性查询（SQL 查询）。
- **劣势**：难以表达渐变现象（如空气污染扩散）。

#### 2.3.2 栅格数据 (Raster)
将世界离散化为规则的网格矩阵。
- **像素 (Pixel)**：每个格子存储一个或多个数值。
- **波段 (Bands)**：
    - 普通照片：3个波段 (Red, Green, Blue)。
    - DEM (高程)：1个波段 (存储高度值，通常是 Float32 或 Int16)。
    - 卫星影像：可能有 4 个（含近红外）、8 个甚至上百个波段（高光谱）。
- **优势**：完美表达连续变化的现象，是卫星遥感和计算机视觉的基础。
- **劣势**：数据量巨大（随分辨率平增长），放大有马赛克，难以进行“对象级”查询。

---

### 2.4 瓦片金字塔 (Tile Pyramid) 与 四叉树

为了在浏览器上流畅加载全球 PB 级的影像数据，我们不能一次性传输整个文件。我们使用“分治法”。

#### 2.4.1 四叉树切分 (Quadtree)
1.  **Level 0**: 全球是一张 $256 \times 256$ 像素的图片。
2.  **切分**: 每一级将上一级的 1 张图片切成 $2 \times 2 = 4$ 张。
3.  **索引**: 通常使用 XYZ 索引法。
    - $Z$: 缩放级别 (Zoom Level)
    - $X$: 列号
    - $Y$: 行号

**数量级爆炸**：
- Zoom 0: 1 张瓦片
- Zoom 10: $4^{10} \approx 100$ 万张瓦片
- Zoom 20: $4^{20} \approx 1$ 万亿张瓦片
这就是为什么我们需要“按需加载”技术。

#### 2.4.2 像素分辨率 (GSD) 计算公式
理解这一公式对于选择购买什么精度的卫星影像至关重要。
在 Web Mercator 投影下，赤道附近的地面分辨率 $Res$ (米/像素) 为：

$$ Res = \frac{2 \pi a}{T \cdot 2^z} $$

其中：
- $a = 6378137$ (地球半径)
- $T = 256$ (瓦片默认尺寸)
- $z$ = Zoom Level

**典型尺度速查表**：
| Zoom | 分辨率 (赤道) | 适用场景 | 对应数据源 |
| :--- | :--- | :--- | :--- |
| **0-5** | > 4 km | 洲际概览、气象云图 | NASA Blue Marble, NOAA |
| **10** | ~ 150 m | 城市分布、大型路网 | Landsat 卫星 |
| **14** | ~ 9.5 m | 街区辨识 | Sentinel-2 (10m) |
| **18** | ~ 0.6 m | 辨识车辆、道路标线 | 吉林一号, Maxar |
| **20** | ~ 0.15 m | 辨识人行道地砖、井盖 | 无人机航测, 街景投影 |

> **Rule of Thumb (经验法则)**：
> 如果你的项目需要识别路面上的**井盖**，你需要优于 15cm (Zoom 20+) 的分辨率。如果你只需要看**农田边界**，Sentinel-2 的 10m (Zoom 14) 通常就够了，且它是免费的。不要花冤枉钱买过高精度的数。

---

## 3. 本章小结

1.  **物理基础**：地球是物理上的不规则体（大地水准面），数学上的椭球体（WGS84），展示时的平面图（Web Mercator）。
2.  **坐标转换**：EPSG:4326 是“世界语”（经纬度），EPSG:3857 是“屏幕语”（米）。所有的 Web 地图开发都在这两者之间不断转换。
3.  **数据选择**：边界明确选矢量，连续变化选栅格。
4.  **瓦片机制**：地图通过四叉树金字塔组织，每深一层，数据量翻 4 倍，分辨率精细 1 倍。
5.  **核心公式**：记住赤道周长约 40,000 公里。Zoom 0 时，1 像素代表 $\approx 156$ 公里。

---

## 4. 常见陷阱与错误 (Gotchas)

### 陷阱 1：小数点的虚假精度
初学者常保留经纬度到小数点后 10 位。
- **事实**：
    - 1 度 $\approx$ 111 km
    - 0.000001 度 ($10^{-6}$) $\approx$ 0.1 米 (10 厘米)
    - 0.00000001 度 ($10^{-8}$) $\approx$ 1 毫米
- **建议**：对于一般的 Web 地图应用（如定位车辆），保留 6 位小数（约 10cm 精度）已绰绰有余。存储过高精度只会浪费带宽和存储空间。

### 陷阱 2：WGS84 与 GCJ-02 (火星坐标) 的混淆
在中国大陆进行地图开发，不可避免会遇到“坐标偏移”问题。
- **现象**：卫星影像（真实的 WGS84）与街道矢量（经过加密的 GCJ-02）叠加时，会有数百米的错位。
- **对策**：必须明确数据源的坐标系。
    - **天地图**：通常提供 WGS84 (CGCS2000) 和 Web Mercator 两种服务。
    - **高德/腾讯**：使用 GCJ-02。
    - **百度**：使用 BD-09 (在 GCJ-02 基础上二次加密)。
    - **处理**：在叠加前，必须使用纠偏算法将它们统一转换到同一坐标系（通常统一转为 WGS84 进行空间分析，展示时再按需转换）。

### 陷阱 3：在 Web Mercator 上画圆
如果你在 EPSG:3857 地图上以某点为中心，画一个半径 10km 的“正圆”缓冲区（Buffer）。
- **结果**：在屏幕上它是圆的，但转换回地球表面，它其实是一个椭圆（高纬度地区）。
- **反之**：如果你在地球表面画一个真实的 10km 圆，投影到 Web Mercator 地图上，它看起来是椭圆的。
- **建议**：进行“缓冲区分析”等空间计算时，务必使用支持测地线（Geodesic）计算的库，或者投影到当地的 UTM 坐标系下进行几何运算。

### 陷阱 4：栅格的“金字塔”不是免费的
在 GIS 软件（如 QGIS, ArcGIS）或服务器（GeoServer）中发布栅格数据时，如果不预先构建“金字塔”（Overviews）。
- **后果**：每次缩放浏览，软件都要读取整个巨大的原始 TIFF 文件并实时重采样，导致软件卡死或服务器崩溃。
- **最佳实践**：任何大于 100MB 的栅格影像，拿到手的第一件事就是构建金字塔（Build Overviews）或转换为 COG (Cloud Optimized GeoTIFF)。
